Примеры тестирования миграций и best-practices работы с [Alembic](https://alembic.sqlalchemy.org/en/latest/).
 
Подготовлено для лекции "Базы данных: модели, миграции, тестирование" 
в [Школе бэкенд-разработки](https://yandex.ru/promo/academy/backend-school/) Яндекса и 
выступления ["Как писать и тестировать миграции БД с Alembic"](https://www.youtube.com/watch?v=qrlTDNaUQ-Q&feature=youtu.be&t=5862) 
на митапе [Moscow Python №69](https://events.yandex.ru/events/moscow-python-meetup-30-10-2019).

## Stairway тест
Простой и эффективный метод проверить, что миграция не содержит опечаток и 
полностью откатывает внесенные изменения в структуру/типы данных. Не требует поддержки - 
достаточно добавить тест в проект один раз и забыть.

В частности, обнаруживает типы данных, созданные в методе `upgrade()` и не 
удаленные в `downgrade()`:  при создании таблиц Alembic автоматически создаст указанные в столбцах типы 
данных (например, enum), но при удалении таблиц не удалит их - это необходимо сделать вручную.

#### Принцип работы
Тест получает список всех миграций и по очереди для каждой миграции вызывает команды Alembic 
`upgrade`, `downgrade`, `upgrade`. Пример можно посмотреть в [tests/test_stairway.py](tests/test_stairway.py).

![Stairway test](assets/stairway.png)

## Data-migration тест
Некоторые миграции не просто добавляют новые столбцы или таблицы, а каким-либо 
образом изменяют данные. 

Помимо проверки, что миграция корректно откатывает изменения струтуры данных (stairway тест) 
требуется проверить, что данные корректно изменяются методом `upgrade()` и 
возвращаются к предыдущему состоянию методом `downgrade()`.

С точки зрения разработки и поддержки этот подход дороже: для каждой миграции с данными 
необходимо разработать отдельный тест и подобрать отдельный набор данных для 
тестирования.

Такой тест не гарантирует отсутствие багов - предусмотреть наборы данных для всех 
случаев очень сложно. Но код изменяющих данные миграций часто бывает сложным, 
ошибки встречаются чаще, а ошибка в такой миграции может иметь самые серьезные последствия.

#### Принцип работы

Тест применяет все миграции до тестируемой и добавляет в базу набор данных, который будет изменен тестируемой миграцией.
Затем выполняется метод `upgrade()` и проверяется, что данные были корректно изменены. 
После этого выполняется метод `downgrade()` к предыдущей миграции и проверяется, что все данные вернулись к начальному состоянию.
Пример можно посмотреть в [tests/test_data_migrations.py](tests/test_data_migrations.py).
